<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@400;600;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0d0f14;
            --surface: #13161e;
            --surface2: #1a1e28;
            --border: #252a38;
            --accent: #f0a500;
            --accent2: #e05c2a;
            --text: #e8eaf0;
            --muted: #636880;
            --success: #2ecc71;
            --danger: #e74c3c;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Syne', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
        }

        /* SIDEBAR */
        .sidebar {
            width: 240px;
            background: var(--surface);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            z-index: 100;
        }

        .logo {
            padding: 28px 24px;
            border-bottom: 1px solid var(--border);
        }

        .logo-text {
            font-size: 20px;
            font-weight: 800;
            letter-spacing: -0.5px;
        }

        .logo-text span {
            color: var(--accent);
        }

        .logo-sub {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--muted);
            margin-top: 4px;
            letter-spacing: 2px;
        }

        .nav {
            flex: 1;
            padding: 20px 12px;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .nav-section {
            font-family: 'Space Mono', monospace;
            font-size: 9px;
            color: var(--muted);
            letter-spacing: 2px;
            padding: 12px 12px 6px;
            text-transform: uppercase;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            color: var(--muted);
            font-size: 14px;
            font-weight: 600;
            transition: all 0.15s ease;
            border: 1px solid transparent;
        }

        .nav-item:hover {
            background: var(--surface2);
            color: var(--text);
        }

        .nav-item.active {
            background: var(--surface2);
            color: var(--accent);
            border-color: var(--border);
        }

        .nav-icon {
            width: 18px;
            text-align: center;
            font-size: 16px;
        }

        .sidebar-footer {
            padding: 16px 12px;
            border-top: 1px solid var(--border);
        }

        .admin-badge {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            background: var(--surface2);
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .avatar {
            width: 32px;
            height: 32px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 800;
            color: var(--bg);
        }

        .admin-info { flex: 1; }
        .admin-name { font-size: 13px; font-weight: 700; }
        .admin-role {
            font-family: 'Space Mono', monospace;
            font-size: 9px;
            color: var(--accent);
            letter-spacing: 1px;
        }

        .logout-btn {
            background: none;
            border: none;
            color: var(--muted);
            cursor: pointer;
            font-size: 16px;
            padding: 4px;
            transition: color 0.15s;
        }
        .logout-btn:hover { color: var(--danger); }

        /* MAIN CONTENT */
        .main {
            margin-left: 240px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .topbar {
            background: var(--surface);
            border-bottom: 1px solid var(--border);
            padding: 0 32px;
            height: 64px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .page-title {
            font-size: 18px;
            font-weight: 800;
        }

        .topbar-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .btn {
            padding: 8px 18px;
            border-radius: 6px;
            border: none;
            font-family: 'Syne', sans-serif;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--bg);
        }
        .btn-primary:hover { background: #ffb822; transform: translateY(-1px); }

        .btn-outline {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }
        .btn-outline:hover { border-color: var(--accent); color: var(--accent); }

        .btn-danger {
            background: var(--danger);
            color: #fff;
        }

        /* CONTENT */
        .content {
            padding: 32px;
            flex: 1;
        }

        /* STATS GRID */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            animation: fadeUp 0.4s ease both;
        }

        .stat-card:nth-child(1) { animation-delay: 0.05s; }
        .stat-card:nth-child(2) { animation-delay: 0.10s; }
        .stat-card:nth-child(3) { animation-delay: 0.15s; }
        .stat-card:nth-child(4) { animation-delay: 0.20s; }

        @keyframes fadeUp {
            from { opacity: 0; transform: translateY(12px); }
            to   { opacity: 1; transform: translateY(0); }
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            background: var(--accent);
        }

        .stat-card:nth-child(2)::before { background: var(--accent2); }
        .stat-card:nth-child(3)::before { background: var(--success); }
        .stat-card:nth-child(4)::before { background: #3498db; }

        .stat-label {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--muted);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
            letter-spacing: -1px;
        }

        .stat-sub {
            font-size: 12px;
            color: var(--muted);
            margin-top: 4px;
        }

        .stat-icon {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 28px;
            opacity: 0.15;
        }

        /* SECTION */
        .section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 24px;
            animation: fadeUp 0.4s ease 0.25s both;
        }

        .section-header {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .section-title {
            font-size: 15px;
            font-weight: 800;
        }

        /* TABLE */
        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--muted);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            text-align: left;
            padding: 12px 24px;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 14px 24px;
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        tr:last-child td { border-bottom: none; }

        tr:hover td { background: var(--surface2); }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            font-family: 'Space Mono', monospace;
        }

        .badge-success { background: rgba(46,204,113,0.12); color: var(--success); }
        .badge-warning { background: rgba(240,165,0,0.12); color: var(--accent); }
        .badge-danger  { background: rgba(231,76,60,0.12);  color: var(--danger); }
        .badge-info    { background: rgba(52,152,219,0.12); color: #3498db; }

        .action-btns {
            display: flex;
            gap: 8px;
        }

        .icon-btn {
            background: var(--surface2);
            border: 1px solid var(--border);
            color: var(--muted);
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.15s;
        }
        .icon-btn:hover { border-color: var(--accent); color: var(--accent); }
        .icon-btn.del:hover { border-color: var(--danger); color: var(--danger); }

        /* GRID 2-COL */
        .grid-2 {
            display: grid;
            grid-template-columns: 1.3fr 1fr;
            gap: 24px;
        }

        /* FORM MODAL */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            z-index: 200;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }

        .modal-overlay.open { display: flex; }

        .modal {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 14px;
            padding: 32px;
            width: 480px;
            max-height: 90vh;
            overflow-y: auto;
            animation: popIn 0.2s ease;
        }

        @keyframes popIn {
            from { transform: scale(0.95); opacity: 0; }
            to   { transform: scale(1); opacity: 1; }
        }

        .modal-title {
            font-size: 18px;
            font-weight: 800;
            margin-bottom: 24px;
        }

        .form-group { margin-bottom: 16px; }
        .form-label {
            display: block;
            font-family: 'Space Mono', monospace;
            font-size: 10px;
            color: var(--muted);
            letter-spacing: 1.5px;
            text-transform: uppercase;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            background: var(--bg);
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 6px;
            font-family: 'Syne', sans-serif;
            font-size: 14px;
            transition: border-color 0.15s;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }

        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 24px;
            justify-content: flex-end;
        }

        /* TOAST */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            background: var(--surface);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            border-radius: 8px;
            padding: 14px 20px;
            font-size: 14px;
            z-index: 999;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }
        .toast.show { transform: translateX(0); }

        /* TOP CATEGORIES */
        .cat-item {
            display: flex;
            align-items: center;
            padding: 14px 24px;
            border-bottom: 1px solid var(--border);
            gap: 14px;
        }
        .cat-item:last-child { border-bottom: none; }

        .cat-bar-wrap {
            flex: 1;
            background: var(--surface2);
            border-radius: 4px;
            height: 6px;
            overflow: hidden;
        }

        .cat-bar {
            height: 100%;
            background: var(--accent);
            border-radius: 4px;
        }

        .cat-name { width: 90px; font-size: 13px; font-weight: 600; }
        .cat-count { font-family: 'Space Mono', monospace; font-size: 12px; color: var(--muted); }

        #productModal .modal { width: 540px; }

        /* EMPTY STATE */
        .empty {
            padding: 40px 24px;
            text-align: center;
            color: var(--muted);
            font-size: 14px;
        }

        .loading-spinner {
            width: 20px; height: 20px;
            border: 2px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.7s linear infinite;
            display: inline-block;
        }

        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<!-- SIDEBAR -->
<aside class="sidebar">
    <div class="logo">
        <div class="logo-text">SHOP<span>ADMIN</span></div>
        <div class="logo-sub">CONTROL PANEL</div>
    </div>

    <nav class="nav">
        <div class="nav-section">Main</div>
        <div class="nav-item active" onclick="showSection('dashboard')">
            <span class="nav-icon">‚ñ¶</span> Dashboard
        </div>
        <div class="nav-item" onclick="showSection('products')">
            <span class="nav-icon">‚¨°</span> Products
        </div>

        <div class="nav-section">Management</div>
        <div class="nav-item" onclick="showSection('orders')">
            <span class="nav-icon">‚óà</span> Orders
        </div>
        <div class="nav-item" onclick="showSection('users')">
            <span class="nav-icon">‚óé</span> Users
        </div>
    </nav>

    <div class="sidebar-footer">
        <div class="admin-badge">
            <div class="avatar">A</div>
            <div class="admin-info">
                <div class="admin-name" id="adminName">Admin</div>
                <div class="admin-role">ADMINISTRATOR</div>
            </div>
            <button class="logout-btn" onclick="logout()" title="Logout">‚èª</button>
        </div>
    </div>
</aside>

<!-- MAIN -->
<main class="main">
    <div class="topbar">
        <div class="page-title" id="pageTitle">Dashboard</div>
        <div class="topbar-actions">
            <button class="btn btn-primary" id="topActionBtn" onclick="openProductModal()">+ Add Product</button>
        </div>
    </div>

    <div class="content">

        <!-- DASHBOARD SECTION -->
        <div id="dashboardSection">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <div class="stat-label">Total Products</div>
                    <div class="stat-value" id="statProducts">‚Äî</div>
                    <div class="stat-sub">In catalog</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üõí</div>
                    <div class="stat-label">Total Orders</div>
                    <div class="stat-value" id="statOrders">‚Äî</div>
                    <div class="stat-sub">All time</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-label">Customers</div>
                    <div class="stat-value" id="statUsers">‚Äî</div>
                    <div class="stat-sub">Registered</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-label">Revenue</div>
                    <div class="stat-value" id="statRevenue">‚Äî</div>
                    <div class="stat-sub">Total earnings</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Recent Orders</div>
                        <button class="btn btn-outline" onclick="showSection('orders')" style="font-size:12px;padding:6px 14px;">View All</button>
                    </div>
                    <div id="recentOrdersTable">
                        <div class="empty"><span class="loading-spinner"></span></div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header">
                        <div class="section-title">Quick Actions</div>
                    </div>
                    <div style="padding:20px;display:flex;flex-direction:column;gap:10px;">
                        <button class="btn btn-primary" style="width:100%;padding:12px;" onclick="openProductModal()">Ôºã Add New Product</button>
                        <button class="btn btn-outline" style="width:100%;padding:12px;" onclick="showSection('products')">‚óà Manage Products</button>
                        <button class="btn btn-outline" style="width:100%;padding:12px;" onclick="showSection('orders')">üìã View All Orders</button>
                        <button class="btn btn-outline" style="width:100%;padding:12px;" onclick="showSection('users')">üë• View Customers</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- PRODUCTS SECTION -->
        <div id="productsSection" style="display:none;">
            <div class="section">
                <div class="section-header">
                    <div class="section-title">All Products</div>
                    <button class="btn btn-primary" onclick="openProductModal()">+ Add Product</button>
                </div>
                <div id="productsTableWrap">
                    <div class="empty"><span class="loading-spinner"></span></div>
                </div>
            </div>
        </div>

        <!-- ORDERS SECTION -->
        <div id="ordersSection" style="display:none;">
            <div class="section">
                <div class="section-header">
                    <div class="section-title">All Orders</div>
                </div>
                <div id="ordersTableWrap">
                    <div class="empty"><span class="loading-spinner"></span></div>
                </div>
            </div>
        </div>

        <!-- USERS SECTION -->
        <div id="usersSection" style="display:none;">
            <div class="section">
                <div class="section-header">
                    <div class="section-title">Registered Customers</div>
                </div>
                <div id="usersTableWrap">
                    <div class="empty"><span class="loading-spinner"></span></div>
                </div>
            </div>
        </div>

    </div>
</main>

<!-- ADD/EDIT PRODUCT MODAL -->
<div class="modal-overlay" id="productModal">
    <div class="modal">
        <div class="modal-title" id="modalTitle">Add New Product</div>
        <input type="hidden" id="editProductId">
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Product Name</label>
                <input class="form-input" id="pName" placeholder="e.g. Wireless Mouse">
            </div>
            <div class="form-group">
                <label class="form-label">Price (‚Çπ)</label>
                <input class="form-input" id="pPrice" type="number" placeholder="e.g. 499">
            </div>
        </div>
        <div class="form-group">
            <label class="form-label">Description</label>
            <textarea class="form-input" id="pDesc" rows="3" placeholder="Product description..."></textarea>
        </div>
        <div class="form-row">
            <div class="form-group">
                <label class="form-label">Stock Quantity</label>
                <input class="form-input" id="pStock" type="number" placeholder="e.g. 100">
            </div>
            <div class="form-group">
                <label class="form-label">Image URL</label>
                <input class="form-input" id="pImage" placeholder="https://...">
            </div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-outline" onclick="closeModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
const API_BASE_URL = "http://localhost:9090";
let currentSection = 'dashboard';

// ---- SECTION NAV ----
function showSection(name) {
    ['dashboard','products','orders','users'].forEach(s => {
        document.getElementById(s + 'Section').style.display = 'none';
    });
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.getElementById(name + 'Section').style.display = 'block';
    document.querySelectorAll('.nav-item').forEach(el => {
        if(el.textContent.toLowerCase().includes(name)) el.classList.add('active');
    });
    document.getElementById('pageTitle').textContent =
        name.charAt(0).toUpperCase() + name.slice(1);
    currentSection = name;

    if(name === 'products') loadProductsTable();
    if(name === 'orders') loadOrdersTable();
    if(name === 'users') loadUsersTable();
}

// ---- TOAST ----
function showToast(msg, type='success') {
    const t = document.getElementById('toast');
    t.textContent = msg;
    t.style.borderLeftColor = type === 'error' ? 'var(--danger)' : 'var(--success)';
    t.classList.add('show');
    setTimeout(() => t.classList.remove('show'), 3000);
}

// ---- LOAD PRODUCTS TABLE ----
function loadProductsTable() {
    fetch(`${API_BASE_URL}/api/products`, { credentials: 'include' })
    .then(r => { if(r.status===401){redirect();}return r.json();})
    .then(data => {
        const products = data.products || [];
        document.getElementById('statProducts').textContent = products.length;
        if(!products.length) {
            document.getElementById('productsTableWrap').innerHTML =
                '<div class="empty">No products yet. Add your first product!</div>';
            return;
        }
        let rows = products.map(p => `
        <tr>
            <td><img src="${p.images&&p.images[0]||'https://via.placeholder.com/40'}"
                style="width:40px;height:40px;object-fit:cover;border-radius:6px;border:1px solid var(--border)"></td>
            <td><strong>${p.name}</strong></td>
            <td>‚Çπ${p.price}</td>
            <td>${p.stock}</td>
            <td><span class="badge ${p.stock>0?'badge-success':'badge-danger'}">${p.stock>0?'IN STOCK':'OUT'}</span></td>
            <td>
                <div class="action-btns">
                    <button class="icon-btn" onclick='openEditModal(${JSON.stringify(p)})'>‚úé Edit</button>
                    <button class="icon-btn del" onclick="deleteProduct(${p.product_id})">‚úï Del</button>
                </div>
            </td>
        </tr>`).join('');
        document.getElementById('productsTableWrap').innerHTML = `
        <table>
            <thead><tr>
                <th>IMG</th><th>NAME</th><th>PRICE</th><th>STOCK</th><th>STATUS</th><th>ACTIONS</th>
            </tr></thead>
            <tbody>${rows}</tbody>
        </table>`;
    }).catch(()=>{
        document.getElementById('productsTableWrap').innerHTML =
            '<div class="empty">Failed to load products.</div>';
    });
}

// ---- LOAD ORDERS ----
function loadOrdersTable() {
    fetch(`${API_BASE_URL}/api/orders`, { credentials: 'include' })
    .then(r => { if(r.status===401){redirect();}return r.json();})
    .then(data => {
        const orders = data.products || [];
        document.getElementById('statOrders').textContent = orders.length;
        if(!orders.length) {
            document.getElementById('ordersTableWrap').innerHTML =
                '<div class="empty">No orders yet.</div>';
            return;
        }
        let rows = orders.map(o => `
        <tr>
            <td><strong>#${o.order_id}</strong></td>
            <td>${o.name}</td>
            <td>√ó${o.quantity}</td>
            <td>‚Çπ${o.price_per_unit}</td>
            <td><strong>‚Çπ${o.total_price}</strong></td>
            <td><span class="badge badge-info">PLACED</span></td>
        </tr>`).join('');
        document.getElementById('ordersTableWrap').innerHTML = `
        <table>
            <thead><tr>
                <th>ORDER ID</th><th>PRODUCT</th><th>QTY</th><th>UNIT PRICE</th><th>TOTAL</th><th>STATUS</th>
            </tr></thead>
            <tbody>${rows}</tbody>
        </table>`;

        // Also fill recent orders on dashboard
        document.getElementById('recentOrdersTable').innerHTML = `
        <table>
            <thead><tr><th>ORDER ID</th><th>PRODUCT</th><th>TOTAL</th><th>STATUS</th></tr></thead>
            <tbody>${orders.slice(0,5).map(o=>`
            <tr>
                <td>#${o.order_id}</td>
                <td>${o.name}</td>
                <td>‚Çπ${o.total_price}</td>
                <td><span class="badge badge-info">PLACED</span></td>
            </tr>`).join('')}</tbody>
        </table>`;
    }).catch(()=>{
        document.getElementById('ordersTableWrap').innerHTML =
            '<div class="empty">Failed to load orders.</div>';
    });
}

// ---- LOAD USERS ----
function loadUsersTable() {
    fetch(`${API_BASE_URL}/api/users`, { credentials: 'include' })
    .then(r => { if(r.status===401){redirect();}return r.json();})
    .then(data => {
        const users = Array.isArray(data) ? data : (data.users || []);
        document.getElementById('statUsers').textContent = users.length;
        if(!users.length) {
            document.getElementById('usersTableWrap').innerHTML =
                '<div class="empty">No users found.</div>';
            return;
        }
        let rows = users.map(u => `
        <tr>
            <td>${u.user_id || u.id || '‚Äî'}</td>
            <td><strong>${u.username}</strong></td>
            <td>${u.email || '‚Äî'}</td>
            <td><span class="badge ${u.role==='ADMIN'?'badge-warning':'badge-success'}">${u.role||'CUSTOMER'}</span></td>
        </tr>`).join('');
        document.getElementById('usersTableWrap').innerHTML = `
        <table>
            <thead><tr><th>ID</th><th>USERNAME</th><th>EMAIL</th><th>ROLE</th></tr></thead>
            <tbody>${rows}</tbody>
        </table>`;
    }).catch(()=>{
        document.getElementById('usersTableWrap').innerHTML =
            '<div class="empty">Failed to load users. Check if /api/users endpoint exists.</div>';
    });
}

// ---- PRODUCT MODAL ----
function openProductModal() {
    document.getElementById('modalTitle').textContent = 'Add New Product';
    document.getElementById('editProductId').value = '';
    ['pName','pPrice','pDesc','pStock','pImage'].forEach(id =>
        document.getElementById(id).value = '');
    document.getElementById('productModal').classList.add('open');
}

function openEditModal(p) {
    document.getElementById('modalTitle').textContent = 'Edit Product';
    document.getElementById('editProductId').value = p.product_id;
    document.getElementById('pName').value = p.name;
    document.getElementById('pPrice').value = p.price;
    document.getElementById('pDesc').value = p.description || '';
    document.getElementById('pStock').value = p.stock;
    document.getElementById('pImage').value = (p.images && p.images[0]) || '';
    document.getElementById('productModal').classList.add('open');
}

function closeModal() {
    document.getElementById('productModal').classList.remove('open');
}

function saveProduct() {
    const editId = document.getElementById('editProductId').value;
    const product = {
        name:  document.getElementById('pName').value,
        price: parseFloat(document.getElementById('pPrice').value),
        description: document.getElementById('pDesc').value,
        stock: parseInt(document.getElementById('pStock').value),
        images: [document.getElementById('pImage').value]
    };
    if(!product.name || !product.price) {
        showToast('Name and price are required.', 'error'); return;
    }
    const isEdit = !!editId;
    const url  = isEdit ? `${API_BASE_URL}/api/products/${editId}` : `${API_BASE_URL}/api/products`;
    const method = isEdit ? 'PUT' : 'POST';

    fetch(url, {
        method, credentials: 'include',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(product)
    })
    .then(r => {
        if(r.ok) {
            closeModal();
            showToast(isEdit ? 'Product updated!' : 'Product added!');
            loadProductsTable();
        } else {
            showToast('Failed to save product.', 'error');
        }
    }).catch(()=> showToast('Server error.','error'));
}

function deleteProduct(id) {
    if(!confirm('Delete this product?')) return;
    fetch(`${API_BASE_URL}/api/products/${id}`, {
        method: 'DELETE', credentials: 'include'
    }).then(r => {
        if(r.ok) { showToast('Product deleted!'); loadProductsTable(); }
        else showToast('Delete failed.','error');
    });
}

// ---- LOGOUT ----
function logout() {
    fetch(`${API_BASE_URL}/api/auth/logout`, { method: 'POST', credentials: 'include' })
    .then(() => { window.location = 'login.html'; });
}

function redirect() { window.location = 'login.html'; }

// ---- INIT ----
window.onload = () => {
    const name = localStorage.getItem('username') || 'Admin';
    document.getElementById('adminName').textContent = name;
    // Load dashboard data
    loadOrdersTable();
    fetch(`${API_BASE_URL}/api/products`, { credentials: 'include' })
    .then(r=>r.json()).then(d=>{
        document.getElementById('statProducts').textContent = (d.products||[]).length;
    }).catch(()=>{});
    // Revenue placeholder
    document.getElementById('statRevenue').textContent = '‚Çπ‚Äî';
};

// Close modal on overlay click
document.getElementById('productModal').addEventListener('click', function(e) {
    if(e.target === this) closeModal();
});
</script>
</body>
</html>